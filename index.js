"use strict";var require$$0$1=require("fs"),require$$0=require("path"),require$$2$1=require("minimist"),require$$1=require("chalk"),require$$2=require("cross-spawn"),require$$4=require("fs-extra");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var require$$0__default$1=_interopDefaultLegacy(require$$0$1),require$$0__default=_interopDefaultLegacy(require$$0),require$$2__default$1=_interopDefaultLegacy(require$$2$1),require$$1__default=_interopDefaultLegacy(require$$1),require$$2__default=_interopDefaultLegacy(require$$2),require$$4__default=_interopDefaultLegacy(require$$4),commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var es={},sync={},utils={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.globalInject=e.override=e.configCreate=e.mdResolver=e.descResolver=e.resolver=e.command=e.FileType=e.Action=void 0;const r=require$$0__default.default,t=require$$1__default.default;var n,i;(i=n=e.Action||(e.Action={})).COPY="COPY",i.REMOVE="REMOVE",i.CREATE="CREATE",i.EXTRACT="EXTRACT",i.PICK="PICK",(i=e.FileType||(e.FileType={})).FILE="FILE",i.FOLDER="FOLDER",e.command=({cmd:o=[]})=>{const t=require$$2__default.default;return new Promise((i,e)=>{0===o.length&&e(Error("没输入命令"));e=o.slice(1);t(o[0],e,{stdio:"inherit"}).on("close",e=>{console.log("close",e),i(e)})})},e.resolver=(i,o,t)=>e=>e.map(([e])=>({action:i?n.COPY:n.REMOVE,origin:i?r.resolve(i):null,target:o?r.join(e,o):r.join(e,i),changedCheckAndBackup:t})),e.descResolver=(i,o,t="desc")=>e=>e.map(([e])=>({action:n.CREATE,origin:o,target:r.join(e,i+"."+t),changedCheckAndBackup:!1})),e.mdResolver=(i,o,t)=>e=>e.map(([e])=>({action:n.PICK,origin:r.resolve(i+".md"),target:r.join(e,i+".md"),changedCheckAndBackup:!1,startWith:o,endWith:t})),e.configCreate=e=>{let i=[];for(const o of e.mapping||[])i=[...i,...o(e.workspaces)];for(const t of e.description||[])i=[...i,...t(e.workspaces)];return{gitPushHook:e.gitPushHook,gitPushOptions:e.gitPushOptions,workspaces:e.workspaces,mapping:i}},e.override=async()=>{globalThis.__console=globalThis.console,globalThis.console=new Proxy({},{get(e,i,o){return"log"===i?(...e)=>{globalThis.__console.log(...e.map((e,i)=>0===i?t.underline(t.bgGreen(t.white(` [${String(e)}] `))):t.green("[")+String(e)+t.green("]")))}:"error"===i?(...e)=>{globalThis.__console.log(...e.map((e,i)=>0===i?t.underline(t.bgRed(t.white(` [${String(e)}] `))):t.red(String(e))))}:void Reflect.get(e,i,o)}})};e.globalInject=()=>{globalThis.resolver=e.resolver,globalThis.descResolver=e.descResolver,globalThis.configCreate=e.configCreate,globalThis.mdResolver=e.mdResolver}}(utils),Object.defineProperty(sync,"__esModule",{value:!0}),sync.run=void 0;const fs=require$$0__default$1.default,path=require$$0__default.default,minimist=require$$2__default$1.default,utils_1=utils,fsExtra=require$$4__default.default,run=async()=>{(0,utils_1.globalInject)(),await(0,utils_1.override)();var e,i,o=minimist(process.argv.slice(2));let n=null;if(!(n=o.c?require(path.resolve(o.c)):require(path.resolve(".syncrc.js"))))throw o="The config file not exist.",console.log("Error",o),Error(o);for(let r in n.mapping)if(n.mapping[r].action===utils_1.Action.CREATE)console.log(n.mapping[r].action,n.mapping[r].origin,n.mapping[r].target),await new Promise((i,o)=>fs.writeFile(n.mapping[r].target,n.mapping[r].origin,e=>{e?o(e):i(null)}));else if(n.mapping[r].action===utils_1.Action.PICK){console.log(n.mapping[r].action,n.mapping[r].origin,n.mapping[r].target);var a=await new Promise((o,t)=>fs.readFile(n.mapping[r].origin,(e,i)=>{e?t(e):o(i)})),l=String(a).split(n.mapping[r].startWith??null);let e="",t=(e=1<l.length?n.mapping[r].startWith+l.slice(1).join(n.mapping[r].startWith):String(a)).split(n.mapping[r].endWith??null)[0];await new Promise((i,o)=>fs.writeFile(n.mapping[r].target,t,e=>{e?o(e):i(null)}))}else n.mapping[r].action===utils_1.Action.COPY?(console.log(n.mapping[r].action+" - Compare:"+n.mapping[r].changedCheckAndBackup,n.mapping[r].origin,n.mapping[r].target),l=await new Promise((o,t)=>{fs.stat(n.mapping[r].origin,(e,i)=>{e?(console.error("ERROR",e),o(null)):i.isFile()?o(utils_1.FileType.FILE):i.isDirectory()?o(utils_1.FileType.FOLDER):t("not file and not folder")})}),a=await new Promise((o,t)=>{fs.stat(n.mapping[r].target,(e,i)=>{e?(console.error("ERROR",e),o(null)):i.isFile()?o(utils_1.FileType.FILE):i.isDirectory()?o(utils_1.FileType.FOLDER):t("not file and not folder")})}),l===utils_1.FileType.FILE&&a===utils_1.FileType.FILE&&n.mapping[r].changedCheckAndBackup&&(e=await new Promise((o,t)=>fs.readFile(n.mapping[r].origin,(e,i)=>{e?t(e):o(i)})),i=await new Promise((o,t)=>fs.readFile(n.mapping[r].target,(e,i)=>{e?t(e):o(i)})),String(e).trim()==String(i).trim()?(console.log("Same",!0),console.log("Backup",!1)):(console.log("Same",!1),await new Promise((i,o)=>fs.rename(n.mapping[r].target,n.mapping[r].target+".backup",e=>{e?o(e):i(null)})),console.log("Backup",n.mapping[r].target+".backup"))),await fsExtra.copy(n.mapping[r].origin,n.mapping[r].target)):n.mapping[r].action===utils_1.Action.REMOVE&&(console.log(n.mapping[r].action,n.mapping[r].origin,n.mapping[r].target),await fsExtra.remove(n.mapping[r].target));for(const s in n.workspaces){var[t,r]=n.workspaces[s];r&&(n.gitPushHook?"string"==typeof n.gitPushHook?await(0,utils_1.command)({cmd:["sh",path.resolve(n.gitPushHook),t,n.gitPushOptions?.origin||"master",n.gitPushOptions?.comments||"Auto sync module"]}):"function"==typeof n.gitPushHook&&await n.gitPushHook(n.workspaces[s],utils_1.command,globalThis.__console):(r=t,await(t=void 0,utils_1.command)({cmd:["sh",path.join(__dirname,"gitpush.sh"),r,t?.origin||"master",t?.comments||"Common Module Sync"]})))}};sync.run=run,function(e){var t=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(e,i,o,t){void 0===t&&(t=o);var r=Object.getOwnPropertyDescriptor(i,o);r&&("get"in r?i.__esModule:!r.writable&&!r.configurable)||(r={enumerable:!0,get:function(){return i[o]}}),Object.defineProperty(e,t,r)}:function(e,i,o,t){e[t=void 0===t?o:t]=i[o]}),i=commonjsGlobal&&commonjsGlobal.__exportStar||function(e,i){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(i,o)||t(i,e,o)};Object.defineProperty(e,"__esModule",{value:!0}),i(sync,e),i(utils,e)}(es);var index=getDefaultExportFromCjs(es);module.exports=index;
