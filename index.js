"use strict";var require$$0$1=require("fs"),require$$0=require("path"),require$$2$1=require("minimist"),require$$1=require("chalk"),require$$2=require("child_process"),require$$4=require("fs-extra");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var require$$0__default$1=_interopDefaultLegacy(require$$0$1),require$$0__default=_interopDefaultLegacy(require$$0),require$$2__default$1=_interopDefaultLegacy(require$$2$1),require$$1__default=_interopDefaultLegacy(require$$1),require$$2__default=_interopDefaultLegacy(require$$2),require$$4__default=_interopDefaultLegacy(require$$4),commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var es={},sync={},utils={};!function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.globalInject=o.gitPush=o.command=o.override=o.configCreate=o.descResolver=o.resolver=o.FileType=o.Action=void 0;const t=require$$0__default.default,n=require$$1__default.default;var a,e;(e=a=o.Action||(o.Action={})).COPY="COPY",e.REMOVE="REMOVE",e.CREATE="CREATE",(e=o.FileType||(o.FileType={})).FILE="FILE",e.FOLDER="FOLDER",o.resolver=(r,i,o)=>e=>e.map(([e])=>({action:r?a.COPY:a.REMOVE,origin:r?t.resolve(r):null,target:i?t.join(e,i):t.join(e,r),changedCheckAndBackup:o})),o.descResolver=(r,i)=>e=>e.map(([e])=>({action:a.CREATE,origin:i,target:t.join(e,r),changedCheckAndBackup:!1})),o.configCreate=e=>{let r=[];for(const i of e.mapping)r=[...r,...i(e.workspaces)];for(const o of e.description)r=[...r,...o(e.workspaces)];return{workspaces:e.workspaces,mapping:r}},o.override=async()=>{globalThis.__console=globalThis.console,globalThis.console=new Proxy({},{get(e,r,i){return"log"===r?(...e)=>{globalThis.__console.log(...e.map((e,r)=>0===r?n.underline(n.bgGreen(n.white(` [${String(e)}] `))):n.green("[")+String(e)+n.green("]")))}:"error"===r?(...e)=>{globalThis.__console.log(...e.map((e,r)=>0===r?n.underline(n.bgRed(n.white(` [${String(e)}] `))):n.red(String(e))))}:void Reflect.get(e,r,i)}})},o.command=({cmd:r=[],onOut:t=e=>e,onErr:n=e=>e})=>{const a=require$$2__default.default.spawn;return new Promise((i,o)=>{0===r.length&&o(Error("没输入命令"));var e=r.slice(1),e=a(r[0],e);e.stdout.on("data",function(e){t(e)}),e.stderr.on("data",function(e){n(e)}),e.on("exit",function(e,r){(0===e?i:o)(e)})})},o.gitPush=async(e,r=e=>e,i)=>{await(0,o.command)({cmd:["sh",t.join(__dirname,"gitpush.sh"),e,i?.origin||"master",i?.comments||"Common Module Sync"],onOut(e){r(e)},onErr(e){r(e)}})};o.globalInject=()=>{globalThis.resolver=o.resolver,globalThis.descResolver=o.descResolver,globalThis.configCreate=o.configCreate}}(utils),Object.defineProperty(sync,"__esModule",{value:!0}),sync.run=void 0;const fs=require$$0__default$1.default,path=require$$0__default.default,minimist=require$$2__default$1.default,utils_1=utils,fsExtra=require$$4__default.default,run=async()=>{(0,utils_1.globalInject)(),await(0,utils_1.override)();var r,i,e=minimist(process.argv.slice(2));let t=null;if(!(t=e.c?require(path.resolve(e.c)):require(path.resolve(".syncrc.js"))))throw e="The config file not exist.",console.log("Error",e),Error(e);for(let e in t.mapping)t.mapping[e].action===utils_1.Action.CREATE?(console.log(t.mapping[e].action,t.mapping[e].origin,t.mapping[e].target+".desc"),await new Promise((r,i)=>fs.writeFile(t.mapping[e].target+".desc",t.mapping[e].origin,e=>{e?i(e):r(null)}))):t.mapping[e].action===utils_1.Action.COPY?(console.log(t.mapping[e].action+" - Compare:"+t.mapping[e].changedCheckAndBackup,t.mapping[e].origin,t.mapping[e].target),r=await new Promise((i,o)=>{fs.stat(t.mapping[e].origin,(e,r)=>{e?(console.error("ERROR",e),i(null)):r.isFile()?i(utils_1.FileType.FILE):r.isDirectory()?i(utils_1.FileType.FOLDER):o("not file and not folder")})}),i=await new Promise((i,o)=>{fs.stat(t.mapping[e].target,(e,r)=>{e?(console.error("ERROR",e),i(null)):r.isFile()?i(utils_1.FileType.FILE):r.isDirectory()?i(utils_1.FileType.FOLDER):o("not file and not folder")})}),r===utils_1.FileType.FILE&&i===utils_1.FileType.FILE&&t.mapping[e].changedCheckAndBackup&&(r=await new Promise((i,o)=>fs.readFile(t.mapping[e].origin,(e,r)=>{e?o(e):i(r)})),i=await new Promise((i,o)=>fs.readFile(t.mapping[e].target,(e,r)=>{e?o(e):i(r)})),String(r).trim()==String(i).trim()?(console.log("Same",!0),console.log("Backup",!1)):(console.log("Same",!1),await new Promise((r,i)=>fs.rename(t.mapping[e].target,t.mapping[e].target+".backup",e=>{e?i(e):r(null)})),console.log("Backup",t.mapping[e].target+".backup"))),await fsExtra.copy(t.mapping[e].origin,t.mapping[e].target)):t.mapping[e].action===utils_1.Action.REMOVE&&(console.log(t.mapping[e].action,t.mapping[e].origin,t.mapping[e].target),await fsExtra.remove(t.mapping[e].target));for(const a in t.workspaces){var[o,n]=t.workspaces[a];n&&await(0,utils_1.gitPush)(o,e=>{console.log("GitPush",e)})}};sync.run=run,function(e){var o=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(e,r,i,o){void 0===o&&(o=i);var t=Object.getOwnPropertyDescriptor(r,i);t&&("get"in t?r.__esModule:!t.writable&&!t.configurable)||(t={enumerable:!0,get:function(){return r[i]}}),Object.defineProperty(e,o,t)}:function(e,r,i,o){e[o=void 0===o?i:o]=r[i]}),r=commonjsGlobal&&commonjsGlobal.__exportStar||function(e,r){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(r,i)||o(r,e,i)};Object.defineProperty(e,"__esModule",{value:!0}),r(sync,e),r(utils,e)}(es);var index=getDefaultExportFromCjs(es);module.exports=index;
