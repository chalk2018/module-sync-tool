"use strict";var require$$0$1=require("fs"),require$$0=require("path"),require$$2$1=require("minimist"),require$$1=require("chalk"),require$$2=require("cross-spawn"),require$$4=require("fs-extra");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var require$$0__default$1=_interopDefaultLegacy(require$$0$1),require$$0__default=_interopDefaultLegacy(require$$0),require$$2__default$1=_interopDefaultLegacy(require$$2$1),require$$1__default=_interopDefaultLegacy(require$$1),require$$2__default=_interopDefaultLegacy(require$$2),require$$4__default=_interopDefaultLegacy(require$$4),commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var es={},sync={},utils={};!function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.globalInject=r.gitPush=r.command=r.override=r.configCreate=r.descResolver=r.resolver=r.FileType=r.Action=void 0;const t=require$$0__default.default,o=require$$1__default.default;var n,e;(e=n=r.Action||(r.Action={})).COPY="COPY",e.REMOVE="REMOVE",e.CREATE="CREATE",(e=r.FileType||(r.FileType={})).FILE="FILE",e.FOLDER="FOLDER",r.resolver=(i,r,o)=>e=>e.map(([e])=>({action:i?n.COPY:n.REMOVE,origin:i?t.resolve(i):null,target:r?t.join(e,r):t.join(e,i),changedCheckAndBackup:o})),r.descResolver=(i,r)=>e=>e.map(([e])=>({action:n.CREATE,origin:r,target:t.join(e,i),changedCheckAndBackup:!1})),r.configCreate=e=>{let i=[];for(const r of e.mapping||[])i=[...i,...r(e.workspaces)];for(const o of e.description||[])i=[...i,...o(e.workspaces)];return{workspaces:e.workspaces,mapping:i}},r.override=async()=>{globalThis.__console=globalThis.console,globalThis.console=new Proxy({},{get(e,i,r){return"log"===i?(...e)=>{globalThis.__console.log(...e.map((e,i)=>0===i?o.underline(o.bgGreen(o.white(` [${String(e)}] `))):o.green("[")+String(e)+o.green("]")))}:"error"===i?(...e)=>{globalThis.__console.log(...e.map((e,i)=>0===i?o.underline(o.bgRed(o.white(` [${String(e)}] `))):o.red(String(e))))}:void Reflect.get(e,i,r)}})},r.command=({cmd:r=[]})=>{const o=require$$2__default.default;return new Promise((i,e)=>{0===r.length&&e(Error("没输入命令"));e=r.slice(1);o(r[0],e,{stdio:"inherit"}).on("close",e=>{console.log("close",e),i(e)})})},r.gitPush=async(e,i)=>{await(0,r.command)({cmd:["sh",t.join(__dirname,"gitpush.sh"),e,i?.origin||"master",i?.comments||"Common Module Sync"]})};r.globalInject=()=>{globalThis.resolver=r.resolver,globalThis.descResolver=r.descResolver,globalThis.configCreate=r.configCreate}}(utils),Object.defineProperty(sync,"__esModule",{value:!0}),sync.run=void 0;const fs=require$$0__default$1.default,path=require$$0__default.default,minimist=require$$2__default$1.default,utils_1=utils,fsExtra=require$$4__default.default,run=async()=>{(0,utils_1.globalInject)(),await(0,utils_1.override)();var i,r,e=minimist(process.argv.slice(2));let t=null;if(!(t=e.c?require(path.resolve(e.c)):require(path.resolve(".syncrc.js"))))throw e="The config file not exist.",console.log("Error",e),Error(e);for(let e in t.mapping)t.mapping[e].action===utils_1.Action.CREATE?(console.log(t.mapping[e].action,t.mapping[e].origin,t.mapping[e].target+".desc"),await new Promise((i,r)=>fs.writeFile(t.mapping[e].target+".desc",t.mapping[e].origin,e=>{e?r(e):i(null)}))):t.mapping[e].action===utils_1.Action.COPY?(console.log(t.mapping[e].action+" - Compare:"+t.mapping[e].changedCheckAndBackup,t.mapping[e].origin,t.mapping[e].target),i=await new Promise((r,o)=>{fs.stat(t.mapping[e].origin,(e,i)=>{e?(console.error("ERROR",e),r(null)):i.isFile()?r(utils_1.FileType.FILE):i.isDirectory()?r(utils_1.FileType.FOLDER):o("not file and not folder")})}),r=await new Promise((r,o)=>{fs.stat(t.mapping[e].target,(e,i)=>{e?(console.error("ERROR",e),r(null)):i.isFile()?r(utils_1.FileType.FILE):i.isDirectory()?r(utils_1.FileType.FOLDER):o("not file and not folder")})}),i===utils_1.FileType.FILE&&r===utils_1.FileType.FILE&&t.mapping[e].changedCheckAndBackup&&(i=await new Promise((r,o)=>fs.readFile(t.mapping[e].origin,(e,i)=>{e?o(e):r(i)})),r=await new Promise((r,o)=>fs.readFile(t.mapping[e].target,(e,i)=>{e?o(e):r(i)})),String(i).trim()==String(r).trim()?(console.log("Same",!0),console.log("Backup",!1)):(console.log("Same",!1),await new Promise((i,r)=>fs.rename(t.mapping[e].target,t.mapping[e].target+".backup",e=>{e?r(e):i(null)})),console.log("Backup",t.mapping[e].target+".backup"))),await fsExtra.copy(t.mapping[e].origin,t.mapping[e].target)):t.mapping[e].action===utils_1.Action.REMOVE&&(console.log(t.mapping[e].action,t.mapping[e].origin,t.mapping[e].target),await fsExtra.remove(t.mapping[e].target));for(const a in t.workspaces){var[o,n]=t.workspaces[a];n&&await(0,utils_1.gitPush)(o)}};sync.run=run,function(e){var o=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(e,i,r,o){void 0===o&&(o=r);var t=Object.getOwnPropertyDescriptor(i,r);t&&("get"in t?i.__esModule:!t.writable&&!t.configurable)||(t={enumerable:!0,get:function(){return i[r]}}),Object.defineProperty(e,o,t)}:function(e,i,r,o){e[o=void 0===o?r:o]=i[r]}),i=commonjsGlobal&&commonjsGlobal.__exportStar||function(e,i){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(i,r)||o(i,e,r)};Object.defineProperty(e,"__esModule",{value:!0}),i(sync,e),i(utils,e)}(es);var index=getDefaultExportFromCjs(es);module.exports=index;
